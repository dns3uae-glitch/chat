<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุฑุงูุจุฉ ุงูุชุฑููุฒ</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
        }
        video {
            border: 5px solid #ccc;
            border-radius: 8px;
            background-color: #000;
            /* ูุฐุง ุงูุณุทุฑ ููู ูู face-api ููุนูู ุจุดูู ุตุญูุญ */
            transform: scaleX(-1);
        }
        button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
        }
        #status {
            font-size: 18px;
            margin-top: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <h2>ูุฑุงูุจุฉ ุงูุชุฑููุฒ</h2>
    <p>ุณูููู ุงูุชุทุจูู ุจูุฑุงูุจุฉ ูุฌููุ ูุณูุฑุณู ุฅุดุนุงุฑุงู ุฅุฐุง ูู ุชูู ูุฑูุฒุงู.</p>
    
    <video id="video" width="600" height="450" autoplay muted playsinline></video>
    
    <button id="startButton">ุชุดุบูู ุงููุงููุฑุง ูุงููุฑุงูุจุฉ</button>
    
    <div id="status">ุงูุฑุฌุงุก ุงูุงูุชุธุงุฑ...</div>

    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>

    <script>
        const video = document.getElementById('video');
        const startButton = document.getElementById('startButton');
        const statusEl = document.getElementById('status');
        
        // ุงููุณุงุฑ ุฅูู ููุงุฐุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู (ุณูุณุชุฎุฏููุง ูู ุณูุฑูุฑ ุขุฎุฑ)
        const MODEL_URL = 'https://cdn.jsdelivr.net/gh/cgarciagl/face-api.js/weights/';

        let detectionInterval; // ุณูุญุชูู ุนูู ุงููุคูุช ุงูุฎุงุต ุจุงููุฑุงูุจุฉ
        let faceMissingTimer = null; // ูุคูุช ูุนุฏู ูุฌูุฏ ุงููุฌู
        const NOTIFY_DELAY = 5000; // 5000 ููููู ุซุงููุฉ = 5 ุซูุงูู

        // --- ุงูุฎุทูุฉ 1: ุทูุจ ุฅุฐู ุงูุฅุดุนุงุฑุงุช ุฃููุงู ---
        document.addEventListener('DOMContentLoaded', () => {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    statusEl.innerText = 'ุฌุงูุฒ. ุงุถุบุท ุนูู ุงูุฒุฑ ูุจุฏุก ุชุดุบูู ุงููุงููุฑุง.';
                } else {
                    statusEl.innerText = 'ูุฑุฌู ุงูุณูุงุญ ุจุงูุฅุดุนุงุฑุงุช ูุชุฌุฑุจุฉ ูุงููุฉ.';
                }
            });
        });

        // --- ุงูุฎุทูุฉ 2: ุชุญููู ุงูููุงุฐุฌ (ุงูุฃูููุฉ) ---
        async function loadModels() {
            statusEl.innerText = 'ูุชู ุชุญููู ููุงุฐุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู...';
            try {
                // ุณูุณุชุฎุฏู "TinyFaceDetector" ูุฃูู ุงูุฃุณุฑุน ูููุชุตูุญ
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                statusEl.innerText = 'ุงูููุงุฐุฌ ุฌุงูุฒุฉ.';
            } catch (err) {
                console.error("ุฎุทุฃ ูู ุชุญููู ุงูููุงุฐุฌ: ", err);
                statusEl.innerText = 'ุฎุทุฃ ูู ุชุญููู ุงูููุงุฐุฌ. ุญุงูู ุชุญุฏูุซ ุงูุตูุญุฉ.';
            }
        }
        loadModels(); // ุชุญููู ุงูููุงุฐุฌ ุจูุฌุฑุฏ ูุชุญ ุงูุตูุญุฉ

        // --- ุงูุฎุทูุฉ 3: ุชุดุบูู ุงููุงููุฑุง ---
        startButton.addEventListener('click', async () => {
            statusEl.innerText = 'ูุทูุจ ุงูุฅุฐู ูููุงููุฑุง...';
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.play();
                startButton.style.display = 'none'; // ุฅุฎูุงุก ุงูุฒุฑ
            } catch (err) {
                console.error("ุฎุทุฃ ูู ุงููุงููุฑุง: ", err);
                statusEl.innerText = 'ุฎุทุฃ: ูู ูุชู ุงูุณูุงุญ ุจุงููุตูู ูููุงููุฑุง.';
            }
        });

        // --- ุงูุฎุทูุฉ 4: ุจุฏุก ุงููุฑุงูุจุฉ (ุจุนุฏ ุชุดุบูู ุงูููุฏูู) ---
        video.addEventListener('play', () => {
            statusEl.innerText = 'ุงููุฑุงูุจุฉ ููุฏ ุงูุชุดุบูู...';
            
            // ุจุฏุก ุญููุฉ ุงููุฑุงูุจุฉ (ูู ุซุงููุฉ)
            detectionInterval = setInterval(async () => {
                // ุงูุชุดุงู ุงููุฌูู ูู ุงูููุฏูู
                const detections = await faceapi.detectAllFaces(video, 
                    new faceapi.TinyFaceDetectorOptions()
                );

                if (detections.length > 0) {
                    // ุชู ุงูุชุดุงู ูุฌู
                    statusEl.innerText = 'ุฃูุช ูุฑูุฒ ๐';
                    // ุฅุนุงุฏุฉ ุถุจุท ุงููุคูุช ุฅุฐุง ูุงู ุงููุฌู ููุฌูุฏุงู
                    faceMissingTimer = null;
                } else {
                    // ูู ูุชู ุงูุชุดุงู ูุฌู
                    statusEl.innerText = 'ูู ูุชู ุงูุชุดุงู ูุฌู...';
                    
                    // ุฅุฐุง ูุงู ูุฐุง ุฃูู ูุฑุฉ ูุฎุชูู ูููุง ุงููุฌูุ ุงุจุฏุฃ ุงููุคูุช
                    if (faceMissingTimer === null) {
                        faceMissingTimer = Date.now();
                    }

                    // ุงูุชุญูู ููุง ุฅุฐุง ูุงู ุงููุฌู ููููุฏุงู ูุฃูุซุฑ ูู 5 ุซูุงูู
                    if (Date.now() - faceMissingTimer > NOTIFY_DELAY) {
                        sendNotification();
                        // ุฅุนุงุฏุฉ ุถุจุท ุงููุคูุช (ุญุชู ูุง ูุฑุณู ุฅุดุนุงุฑุงู ูู ุซุงููุฉ)
                        faceMissingTimer = null; 
                    }
                }
            }, 1000); // ูุชู ุงููุญุต ูู 1000 ููููู ุซุงููุฉ (ูู ุซุงููุฉ)
        });

        // --- ุงูุฎุทูุฉ 5: ุฏุงูุฉ ุฅุฑุณุงู ุงูุฅุดุนุงุฑ ---
        function sendNotification() {
            if (Notification.permission === 'granted') {
                const title = 'ุงูุชุจู ูุฑูุฒ!';
                const options = {
                    body: 'ูุจุฏู ุฃูู ูุณุช ุฃูุงู ุงูุดุงุดุฉ. ุฎุฐ ูุชุฑุฉ ุฑุงุญุฉ ุฅุฐุง ุฃุฑุฏุช.',
                    icon: 'https://cdn-icons-png.flaticon.com/512/138/138406.png' // ุฃููููุฉ ุชูุจูู
                };
                new Notification(title, options);
            }
        }
    </script>

</body>
</html>
