<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุฑุงูุจุฉ ุงูุชุฑููุฒ ุงููุชูุฏูุฉ</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
        }
        video {
            border: 5px solid #ccc;
            border-radius: 8px;
            background-color: #000;
            transform: scaleX(-1); /* ูุฑุขุฉ */
        }
        button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
        }
        #status {
            font-size: 18px;
            margin-top: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <h2>ูุฑุงูุจุฉ ุงูุชุฑููุฒ ุงููุชูุฏูุฉ</h2>
    
    <video id="video" width="600" height="450" autoplay muted playsinline></video>
    
    <button id="startButton">ุชุดุบูู ุงููุงููุฑุง ูุงููุฑุงูุจุฉ</button>
    
    <div id="status">ุงูุฑุฌุงุก ุงูุงูุชุธุงุฑ...</div>

    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>

    <script>
        const video = document.getElementById('video');
        const startButton = document.getElementById('startButton');
        const statusEl = document.getElementById('status');
        
        const MODEL_URL = 'https://cdn.jsdelivr.net/gh/cgarciagl/face-api.js/weights/';

        // --- ุฅุนุฏุงุฏุงุช ุงููุคูุชุงุช ูุงูุญุฏูุฏ ---
        let detectionInterval;
        let faceMissingSince = null; // ูุคูุช ุบูุงุจ ุงููุฌู
        let eyesClosedSince = null;  // ูุคูุช ุฅุบูุงู ุงูุนูู
        let lookingAwaySince = null; // ูุคูุช ุงููุธุฑ ุจุนูุฏุงู

        // (ููู ููุถุจุท ูุงูููุงุฒูุฉ)
        const EYE_CLOSED_THRESHOLD = 0.22; // ุญุฏ ูุณุจุฉ ุฃุจุนุงุฏ ุงูุนูู (EAR)
        const LOOKING_AWAY_THRESHOLD = 1.8; // ุญุฏ ูุณุจุฉ ุงุชุฌุงู ุงููุฌู (Gaze)
        
        const FACE_MISSING_DELAY = 5000;  // 5 ุซูุงูู ูุบูุงุจ ุงููุฌู
        const EYE_CLOSED_DELAY = 2000;    // ุซุงููุชุงู ูุฅุบูุงู ุงูุนูู (ููุชุนุจ)
        const LOOKING_AWAY_DELAY = 3000;  // 3 ุซูุงูู ูููุธุฑ ุจุนูุฏุงู

        // --- 1. ุทูุจ ุฅุฐู ุงูุฅุดุนุงุฑุงุช ---
        document.addEventListener('DOMContentLoaded', () => {
            Notification.requestPermission().then(permission => {
                statusEl.innerText = (permission === 'granted') ? 
                    'ุฌุงูุฒ. ุงุถุบุท ุนูู ุงูุฒุฑ.' : 
                    'ูุฑุฌู ุงูุณูุงุญ ุจุงูุฅุดุนุงุฑุงุช.';
            });
        });

        // --- 2. ุชุญููู ุงูููุงุฐุฌ (ุจูุง ูู ุฐูู ูุนุงูู ุงููุฌู) ---
        async function loadModels() {
            statusEl.innerText = 'ูุชู ุชุญููู ููุงุฐุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู...';
            try {
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                // ูุฐุง ูู ุงููููุฐุฌ ุงูุฌุฏูุฏ ูุงูููู ูุชุญููู ุงูุนููู
                await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                statusEl.innerText = 'ุงูููุงุฐุฌ ุฌุงูุฒุฉ.';
            } catch (err) {
                console.error("ุฎุทุฃ ูู ุชุญููู ุงูููุงุฐุฌ: ", err);
                statusEl.innerText = 'ุฎุทุฃ ูู ุชุญููู ุงูููุงุฐุฌ.';
            }
        }
        loadModels();

        // --- 3. ุชุดุบูู ุงููุงููุฑุง ---
        startButton.addEventListener('click', async () => {
            statusEl.innerText = 'ูุทูุจ ุงูุฅุฐู ูููุงููุฑุง...';
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
            } catch (err) {
                console.error("ุฎุทุฃ ูู ุงููุงููุฑุง: ", err);
                statusEl.innerText = 'ุฎุทุฃ: ูู ูุชู ุงูุณูุงุญ ุจุงููุตูู ูููุงููุฑุง.';
            }
        });

        // --- 4. ุจุฏุก ุงููุฑุงูุจุฉ (ุงูููุทู ุงูุฑุฆูุณู) ---
        video.addEventListener('play', () => {
            statusEl.innerText = 'ุงููุฑุงูุจุฉ ููุฏ ุงูุชุดุบูู...';
            
            detectionInterval = setInterval(async () => {
                const now = Date.now();
                
                // ุงูุชุดุงู ุงููุฌู + ูุนุงูู ุงููุฌู
                const detections = await faceapi.detectAllFaces(video, 
                    new faceapi.TinyFaceDetectorOptions()
                ).withFaceLandmarks();

                // --- ุงูุญุงูุฉ 1: ูุง ููุฌุฏ ูุฌู ---
                if (detections.length === 0) {
                    statusEl.innerText = 'ูู ูุชู ุงูุชุดุงู ูุฌู...';
                    if (faceMissingSince === null) faceMissingSince = now; // ุงุจุฏุฃ ุงููุคูุช
                    
                    // ุฅุฐุง ูุงู ุงููุฌู ููููุฏุงู ูุฃูุซุฑ ูู 5 ุซูุงูู
                    if (now - faceMissingSince > FACE_MISSING_DELAY) {
                        sendNotification("ุฑูุฒ ูู ุงูุตูุญุฉ", "ูุจุฏู ุฃูู ูุณุช ุฃูุงู ุงูุดุงุดุฉ.");
                        faceMissingSince = null; // ุฃุนุฏ ุงูุถุจุท ูุชุฌูุจ ุงูุฅุดุนุงุฑุงุช ุงููุชูุฑุฑุฉ
                    }
                    // ุฅุนุงุฏุฉ ุถุจุท ุงููุคูุชุงุช ุงูุฃุฎุฑู
                    eyesClosedSince = null;
                    lookingAwaySince = null;
                    return; // ุชููู ููุง
                }

                // --- ุงูุญุงูุฉ 2: ุชู ุงูุชุดุงู ูุฌู ---
                faceMissingSince = null; // ุฃุนุฏ ุถุจุท ูุคูุช ุบูุงุจ ุงููุฌู
                const landmarks = detections[0].landmarks;

                // --- 2ุฃ: ุชุญููู ุฅุบูุงู ุงูุนูู (ุงูุชุนุจ) ---
                const avgEAR = getAverageEAR(landmarks);
                
                if (avgEAR < EYE_CLOSED_THRESHOLD) {
                    statusEl.innerText = 'ุนูููู ูุบููุชุงู...';
                    if (eyesClosedSince === null) eyesClosedSince = now; // ุงุจุฏุฃ ูุคูุช ุงูุชุนุจ
                    
                    if (now - eyesClosedSince > EYE_CLOSED_DELAY) {
                        sendNotification("ุฃูุช ูุฑูู", "ุฎุฐ ูุชุฑุฉ ุฑุงุญุฉ.");
                        eyesClosedSince = null; // ุฃุนุฏ ุงูุถุจุท
                    }
                } else {
                    eyesClosedSince = null; // ุฃุนุฏ ุถุจุท ูุคูุช ุงูุชุนุจ (ุงูุนููู ููุชูุญุฉ)
                }

                // --- 2ุจ: ุชุญููู ุงุชุฌุงู ุงููุฌู (ุงูุชุดุชุช) ---
                // (ูุง ูุชุญูู ูู ุงูุชุดุชุช ุฅุฐุง ูุงูุช ุงูุนููู ูุบููุฉ)
                if (eyesClosedSince === null) {
                    const gazeRatio = getGazeRatio(landmarks);
                    
                    if (gazeRatio > LOOKING_AWAY_THRESHOLD || gazeRatio < (1 / LOOKING_AWAY_THRESHOLD)) {
                        statusEl.innerText = 'ูุจุฏู ุฃูู ุชูุธุฑ ุจุนูุฏุงู...';
                        if (lookingAwaySince === null) lookingAwaySince = now; // ุงุจุฏุฃ ูุคูุช ุงูุชุดุชุช
                        
                        if (now - lookingAwaySince > LOOKING_AWAY_DELAY) {
                            sendNotification("ุฑูุฒ ูู ุงูุตูุญุฉ", "ูุจุฏู ุฃูู ุบูุฑ ููุชุจู.");
                            lookingAwaySince = null; // ุฃุนุฏ ุงูุถุจุท
                        }
                    } else {
                        statusEl.innerText = 'ุฃูุช ูุฑูุฒ ๐';
                        lookingAwaySince = null; // ุฃุนุฏ ุถุจุท ูุคูุช ุงูุชุดุชุช
                    }
                }

            }, 700); // ูุชู ุงููุญุต ูู 700 ููููู ุซุงููุฉ (ูุชูููุฑ ุงูุฃุฏุงุก)
        });

        // --- 5. ุฏุงูุฉ ุฅุฑุณุงู ุงูุฅุดุนุงุฑ (ูุนุฏูุฉ) ---
        function sendNotification(title, body) {
            if (Notification.permission === 'granted') {
                const options = { body: body };
                new Notification(title, options);
            }
        }

        // --- ุฏูุงู ูุณุงุนุฏุฉ ูุญุณุงุจุงุช ุงููุฌู ---

        // ุฏุงูุฉ ูุญุณุงุจ ุงููุณุงูุฉ ุจูู ููุทุชูู
        function getDistance(p1, p2) {
            return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
        }

        // ุฏุงูุฉ ูุญุณุงุจ ูุณุจุฉ ุฃุจุนุงุฏ ุงูุนูู (EAR)
        function getEAR(eye) {
            // eye ูู ูุตูููุฉ ูู 6 ููุงุท
            const a = getDistance(eye[1], eye[5]);
            const b = getDistance(eye[2], eye[4]);
            const c = getDistance(eye[0], eye[3]);
            return (a + b) / (2.0 * c);
        }

        // ุฏุงูุฉ ูุญุณุงุจ ูุชูุณุท EAR ููุนูููู
        function getAverageEAR(landmarks) {
            const leftEye = landmarks.getLeftEye();
            const rightEye = landmarks.getRightEye();
            const leftEAR = getEAR(leftEye);
            const rightEAR = getEAR(rightEye);
            return (leftEAR + rightEAR) / 2.0;
        }

        // ุฏุงูุฉ ูุญุณุงุจ ูุณุจุฉ ุงุชุฌุงู ุงููุฌู (ุชูุฏูุฑูุฉ)
        function getGazeRatio(landmarks) {
            const leftEye = landmarks.getLeftEye();
            const rightEye = landmarks.getRightEye();
            const nose = landmarks.getNose();
            
            // ุญุณุงุจ ุงูููุทุฉ ุงููุฑูุฒูุฉ ุจูู ุงูุนูููู
            const eyeCenterX = (leftEye[0].x + rightEye[3].x) / 2;
            const eyeCenterY = (leftEye[0].y + rightEye[3].y) / 2;

            // ูุณุจุฉ ุงููุณุงูุฉ ุงูุฃูููุฉ ูู ูุฑูุฒ ุงูุนูู ุฅูู ุงูุฃูู
            // ูุฐู ุทุฑููุฉ ุชูุฏูุฑูุฉ ุจุณูุทุฉ ุฌุฏุงู
            const gazeRatio = (eyeCenterX - nose[3].x) / (getDistance(leftEye[0], rightEye[3]));
            // ูุณุชุฎุฏู ุงููููุฉ ุงููุทููุฉ ููุถุงุนู ูุฌุนููุง ุฃุณูู ูู ุงูููุงุฑูุฉ
            return Math.abs(gazeRatio) * 10; 
        }

    </script>
</body>
</html>
