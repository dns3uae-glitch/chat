<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØ±ÙƒÙŠØ² (Ù…Ø¨Ø³Ø·Ø©)</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
        }
        video {
            border: 5px solid #ccc;
            border-radius: 8px;
            background-color: #000;
            transform: scaleX(-1); /* Ù…Ø±Ø¢Ø© */
            margin-bottom: 20px;
        }
        button {
            margin: 10px;
            padding: 12px 25px;
            font-size: 18px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #28a745; /* Ù„ÙˆÙ† Ø£Ø®Ø¶Ø± Ø¬Ù…ÙŠÙ„ */
            color: white;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #218838;
        }
        #status {
            font-size: 20px;
            margin-top: 30px;
            font-weight: bold;
            color: #007bff;
        }
        .warning {
            color: #dc3545; /* Ù„ÙˆÙ† Ø£Ø­Ù…Ø± Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
        }
    </style>
</head>
<body>

    <h2>Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØ±ÙƒÙŠØ² Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
    <p>Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ¬ÙˆØ¯Ùƒ ÙˆØ§ØªØ¬Ø§Ù‡ ÙˆØ¬Ù‡Ùƒ.</p>
    
    <video id="video" width="600" height="450" autoplay muted playsinline></video>
    
    <button id="startButton">ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</button>
    
    <div id="status">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</div>

    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>

    <script>
        const video = document.getElementById('video');
        const startButton = document.getElementById('startButton');
        const statusEl = document.getElementById('status');
        
        const MODEL_URL = 'https://cdn.jsdelivr.net/gh/cgarciagl/face-api.js/weights/';

        let detectionInterval;
        let faceMissingSince = null; // Ù…Ø¤Ù‚Øª ØºÙŠØ§Ø¨ Ø§Ù„ÙˆØ¬Ù‡
        let lookingAwaySince = null; // Ù…Ø¤Ù‚Øª Ø§Ù„Ù†Ø¸Ø± Ø¨Ø¹ÙŠØ¯Ø§Ù‹

        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ© (ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§) ---
        const LOOKING_AWAY_THRESHOLD = 1.8; // Ø­Ø¯ Ù†Ø³Ø¨Ø© Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ÙˆØ¬Ù‡: Ù‚ÙŠÙ…Ø© Ø£ÙƒØ¨Ø± = Ø­Ø³Ø§Ø³ÙŠØ© Ø£Ù‚Ù„ (ÙŠØªØ·Ù„Ø¨ Ø¯ÙˆØ±Ø§Ù† Ø£ÙƒØ¨Ø±)
                                            // Ù‚ÙŠÙ…Ø© Ø£ØµØºØ± = Ø­Ø³Ø§Ø³ÙŠØ© Ø£Ø¹Ù„Ù‰ (ÙŠÙ„ØªÙ‚Ø· Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©)
        
        const FACE_MISSING_DELAY = 4000;  // 4 Ø«ÙˆØ§Ù†Ù Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙˆØ¬Ù‡ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        const LOOKING_AWAY_DELAY = 3000;  // 3 Ø«ÙˆØ§Ù†Ù Ù„Ù„Ù†Ø¸Ø± Ø¨Ø¹ÙŠØ¯Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±

        // --- 1. Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ---
        document.addEventListener('DOMContentLoaded', () => {
            Notification.requestPermission().then(permission => {
                statusEl.innerText = (permission === 'granted') ? 
                    'Ø¬Ø§Ù‡Ø². Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.' : 
                    'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„ØªÙ„Ù‚ÙŠ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª.';
            });
        });

        // --- 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ (ÙÙ‚Ø· Ù„Ø§ÙƒØªØ´Ø§Ù Ø§Ù„ÙˆØ¬Ù‡ ÙˆÙ…Ø¹Ø§Ù„Ù…Ù‡) ---
        async function loadModels() {
            statusEl.innerText = 'ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ... Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø§Ù„Ø£Ù…Ø± Ø¨Ø¹Ø¶ Ø§Ù„ÙˆÙ‚Øª.';
            try {
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                statusEl.innerText = 'Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø¬Ø§Ù‡Ø²Ø©ØŒ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ´ØºÙŠÙ„.';
            } catch (err) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬: ", err);
                statusEl.innerText = 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬. Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.';
                statusEl.classList.add('warning');
            }
        }
        loadModels();

        // --- 3. ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ---
        startButton.addEventListener('click', async () => {
            statusEl.innerText = 'Ù†Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§...';
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                startButton.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„
            } catch (err) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ", err);
                statusEl.innerText = 'Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§.';
                statusEl.classList.add('warning');
            }
        });

        // --- 4. Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© (Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ) ---
        video.addEventListener('play', () => {
            statusEl.innerText = 'Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„ØŒ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©...';
            statusEl.classList.remove('warning');
            
            detectionInterval = setInterval(async () => {
                const now = Date.now();
                
                // Ø§ÙƒØªØ´Ø§Ù Ø§Ù„ÙˆØ¬Ù‡ + Ù…Ø¹Ø§Ù„Ù… Ø§Ù„ÙˆØ¬Ù‡
                const detections = await faceapi.detectAllFaces(video, 
                    new faceapi.TinyFaceDetectorOptions()
                ).withFaceLandmarks();

                // --- Ø§Ù„Ø­Ø§Ù„Ø© 1: Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØ¬Ù‡ ---
                if (detections.length === 0) {
                    statusEl.innerText = 'Ù„Ù… ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù ÙˆØ¬Ù‡. (ØºÙŠØ§Ø¨)';
                    statusEl.classList.add('warning');
                    if (faceMissingSince === null) faceMissingSince = now; 
                    
                    if (now - faceMissingSince > FACE_MISSING_DELAY) {
                        sendNotification("Ø§Ù†ØªØ¨Ù‡ ÙˆØ±ÙƒØ²!", "ÙŠØ¨Ø¯Ùˆ Ø£Ù†Ùƒ Ù„Ø³Øª Ø£Ù…Ø§Ù… Ø§Ù„Ø´Ø§Ø´Ø©. Ø¹Ø¯ Ø¥Ù„Ù‰ ØµÙØ­ØªÙƒ.");
                        faceMissingSince = null; // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø· Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©
                    }
                    lookingAwaySince = null; // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ù…Ø¤Ù‚Øª Ø§Ù„Ù†Ø¸Ø± Ø¨Ø¹ÙŠØ¯Ø§Ù‹
                    return; // ØªÙˆÙ‚Ù Ù‡Ù†Ø§
                }

                // --- Ø§Ù„Ø­Ø§Ù„Ø© 2: ØªÙ… Ø§ÙƒØªØ´Ø§Ù ÙˆØ¬Ù‡ ---
                statusEl.classList.remove('warning');
                faceMissingSince = null; // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ù…Ø¤Ù‚Øª ØºÙŠØ§Ø¨ Ø§Ù„ÙˆØ¬Ù‡

                const landmarks = detections[0].landmarks;

                // --- ØªØ­Ù„ÙŠÙ„ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ÙˆØ¬Ù‡ (Ù„Ù„ØªØ´ØªØª) ---
                const gazeRatio = getGazeRatio(landmarks);
                
                if (gazeRatio > LOOKING_AWAY_THRESHOLD || gazeRatio < (1 / LOOKING_AWAY_THRESHOLD)) {
                    statusEl.innerText = 'ÙŠØ¨Ø¯Ùˆ Ø£Ù†Ùƒ ØªÙ†Ø¸Ø± Ø¨Ø¹ÙŠØ¯Ø§Ù‹ Ø¹Ù† Ø§Ù„Ø´Ø§Ø´Ø©...';
                    statusEl.classList.add('warning');
                    if (lookingAwaySince === null) lookingAwaySince = now; 
                    
                    if (now - lookingAwaySince > LOOKING_AWAY_DELAY) {
                        sendNotification("Ø±ÙƒØ² ÙÙŠ Ø§Ù„ØµÙØ­Ø©!", "ÙŠØ¨Ø¯Ùˆ Ø£Ù†Ùƒ ØºÙŠØ± Ù…Ù†ØªØ¨Ù‡ ÙˆØªÙ†Ø¸Ø± Ø¨Ø¹ÙŠØ¯Ø§Ù‹.");
                        lookingAwaySince = null; 
                    }
                } else {
                    statusEl.innerText = 'Ø£Ù†Øª Ù…Ø±ÙƒØ² ğŸ‘';
                    lookingAwaySince = null; 
                }

            }, 800); // ÙŠØªÙ… Ø§Ù„ÙØ­Øµ ÙƒÙ„ 800 Ù…ÙŠÙ„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©
        });

        // --- 5. Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ---
        function sendNotification(title, body) {
            if (Notification.permission === 'granted') {
                const options = { 
                    body: body,
                    icon: 'https://cdn-icons-png.flaticon.com/512/138/138406.png' // Ø£ÙŠÙ‚ÙˆÙ†Ø© ØªÙ†Ø¨ÙŠÙ‡
                };
                new Notification(title, options);
            }
        }

        // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ÙˆØ¬Ù‡ (Ù„ØªØ­Ù„ÙŠÙ„ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ÙˆØ¬Ù‡) ---
        function getDistance(p1, p2) {
            return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
        }

        function getGazeRatio(landmarks) {
            const leftEye = landmarks.getLeftEye();
            const rightEye = landmarks.getRightEye();
            const nose = landmarks.getNose();
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© Ø¨ÙŠÙ† Ø§Ù„Ø¹ÙŠÙ†ÙŠÙ†
            const eyeCenterX = (leftEye[0].x + rightEye[3].x) / 2;

            // Ù‡Ø°Ù‡ Ø·Ø±ÙŠÙ‚Ø© ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ø¨Ø³ÙŠØ·Ø© Ø¬Ø¯Ø§Ù‹ Ù„Ù‚ÙŠØ§Ø³ Ù…Ø¯Ù‰ Ø§Ù†Ø­Ø±Ø§Ù Ø§Ù„Ø£Ù†Ù Ø¹Ù† Ø§Ù„Ù…Ù†ØªØµÙ
            const gazeRatio = (eyeCenterX - nose[3].x) / (getDistance(leftEye[0], rightEye[3]));
            return Math.abs(gazeRatio) * 10; 
        }

    </script>
</body>
</html>
